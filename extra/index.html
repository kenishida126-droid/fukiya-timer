<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extra Ver.01 練習専用簡易版</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  color: #fff;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  text-align: center;
  /* 文字選択を全面禁止（長押し対策） */
  -webkit-user-select: none;
  user-select: none;
}

/* ===== タイトル ===== */
#title { margin-top: 30px; line-height: 1.2; }
#title-main { font-size: 28px; }
#title-sub  { font-size: 20px; }
#title-sign  { font-size: 20px; }

/* ===== タイマー ===== */
#timer {
  margin: 5vh 0;
  font-size: 45vw;
  font-weight: bold;
  line-height: 1;
  transform: scaleY(1.3);
  cursor: pointer;
  user-select: none;
}

.timer-lime { color: #00ff00; }
.timer-gold { color: #d4af37; }
.timer-red  { color: #ff0000; }

.blink-slow { animation: blinkSlow 1s steps(1) infinite; }
@keyframes blinkSlow { 50% { opacity: 0; } }

.blink-fast { animation: blinkFast 0.3s steps(1) infinite; }
@keyframes blinkFast { 50% { opacity: 0; } }

/* ===== Shot Pace ===== */
#shotpace {
  position: relative;
  width: 100vw;
  cursor: pointer;
}

#arrows {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  width: 100%;
}

/* ===== 矢（完成形） ===== */
.arrow {
  position: relative;
  margin: auto;
  width: 46px;
  height: 210px;
  clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
  background:
    linear-gradient(
      90deg,
      #8b0000 0%,
      #b30000 35%,
      #ff6a6a 55%,
      #b30000 70%,
      #7a0000 100%
    );
}

.arrow::after {
  content: "";
  position: absolute;
  bottom: -2px;
  left: 4px;
  width: 38px;
  height: 10px;
  background: radial-gradient(
    ellipse at center,
    rgba(255,255,255,0.35) 0%,
    rgba(120,0,0,0.9) 70%
  );
  border-radius: 50%;
}

.blink { animation: arrowBlink 1s step-start infinite; }
@keyframes arrowBlink { 50% { opacity: 0; } }

#label {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  color: #00ff00;
  pointer-events: none;
}
</style>
</head>

<body>

<div id="title">
  <div id="title-main">スポーツ吹矢タイマー</div>
  <div id="title-sub">《 Extra Ver.01～練習専用簡易版 》</div>
  <div id="title-sign">～ by Ken.Ishida ～</div>
</div>

<div id="timer" class="timer-lime">3:05</div>

<div id="shotpace">
  <div id="arrows">
    <div class="arrow"></div><div class="arrow"></div>
    <div class="arrow"></div><div class="arrow"></div>
    <div class="arrow"></div>
  </div>
  <div id="label">Shot Pace – Arrows</div>
</div>

<script>
const TOTAL = 185;
const READY = 180;

let time = TOTAL;
let running = false;
let intervalId = null;
let shotPace = false;
let prevIndex = -1;

/* ===== WakeLock ===== */
let wakeLock = null;

async function requestWakeLock() {
  try {
    if ('wakeLock' in navigator) {
      wakeLock = await navigator.wakeLock.request('screen');
    }
  } catch {}
}

function releaseWakeLock() {
  if (wakeLock) {
    wakeLock.release().catch(()=>{});
    wakeLock = null;
  }
}

document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible" && running) {
    requestWakeLock();
  }
});

const timer = document.getElementById("timer");
const arrows = [...document.querySelectorAll(".arrow")];
const label = document.getElementById("label");

const ranges = [[180,142],[141,108],[107,74],[73,40],[39,0]];

/* ===== Audio : BEEP分離 ===== */
const ctx = new (window.AudioContext || window.webkitAudioContext)();

function beepArrow() {          // 矢切替用（大）
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.connect(g); g.connect(ctx.destination);
  o.frequency.value = 2000;
  g.gain.value = 0.6;
  o.start(); o.stop(ctx.currentTime + 0.08);
}

function beepTap() {            // タップ用（小）
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.connect(g); g.connect(ctx.destination);
  o.frequency.value = 1800;
  g.gain.value = 0.15;
  o.start(); o.stop(ctx.currentTime + 0.05);
}

const audioStart = new Audio("start-0.mp3");
const audio30 = new Audio("30sec.mp3");
const audioEnd = new Audio("end.mp3");

function updateTimer() {
  const m = Math.floor(time / 60);
  const s = time % 60;
  timer.textContent = `${m}:${s.toString().padStart(2,"0")}`;
  timer.className = "";
  if (time === TOTAL || time > READY) timer.classList.add("timer-lime");
  else if (time > 30) timer.classList.add("timer-gold");
  else if (time > 0) timer.classList.add("timer-red","blink-slow");
  else timer.classList.add("timer-lime","blink-fast");
}

function arrowsOff() {
  arrows.forEach(a => {
    a.classList.remove("blink");
    a.style.visibility = "hidden";
  });
  label.style.display = "flex";
}

function arrowsOn() {
  arrows.forEach(a => {
    a.classList.remove("blink");
    a.style.visibility = "visible";
  });
  label.style.display = "none";
}

function updateArrows() {
  const idx = ranges.findIndex(r => time <= r[0] && time >= r[1]);
  arrows.forEach((a,i)=>{
    a.classList.remove("blink");
    a.style.visibility = time < ranges[i][1] ? "hidden":"visible";
  });
  if (idx>=0 && time>0) {
    arrows[idx].classList.add("blink");
    if (prevIndex>=0 && idx!==prevIndex) beepArrow();
  }
  prevIndex = idx;
}

function resetAll() {
  clearInterval(intervalId);
  intervalId = null;
  running = false;
  releaseWakeLock();
  time = TOTAL;
  prevIndex = -1;
  updateTimer();
  shotPace ? arrowsOn() : arrowsOff();
}

timer.onclick = async () => {
  beepTap();
  if (!running && time === TOTAL) {
    running = true;
    await requestWakeLock();

    intervalId = setInterval(() => {

      if (time === 182) audioStart.play();
      if (time === 31) audio30.play();
      if (time === 1) audioEnd.play();

      if (time <= 0) {
        clearInterval(intervalId);
        running = false;
        releaseWakeLock();
        arrowsOff();
        updateTimer();
        return;
      }

      time--;
      updateTimer();
      if (shotPace && time <= READY) updateArrows();

    }, 1000);
  } else {
    resetAll();
  }
};

shotpace.onclick = () => {
  if (running) return;
  shotPace = !shotPace;
  shotPace ? arrowsOn() : arrowsOff();
};

updateTimer();
arrowsOff();
</script>

</body>
</html>
